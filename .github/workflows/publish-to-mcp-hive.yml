name: Publish to MCP Hive

on:
  push:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      force_publish:
        description: "Force publish even if not a release"
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      MCP_SERVER_URL: https://mcp-hive.ti.trilogy.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Verify required secrets
        run: |
          [ -n "${{ secrets.MCP_HIVE_API_KEY }}" ] || { echo "âŒ MCP_HIVE_API_KEY missing"; exit 1; }
          [ -n "${{ secrets.MCP_HIVE_ID }}" ] || { echo "âŒ MCP_HIVE_ID missing"; exit 1; }
          [ -n "${{ secrets.OAUTH_CLIENT_ID }}" ] || { echo "âŒ OAUTH_CLIENT_ID missing"; exit 1; }
          [ -n "${{ secrets.OAUTH_CLIENT_SECRET }}" ] || { echo "âŒ OAUTH_CLIENT_SECRET missing"; exit 1; }
          [ -n "${{ secrets.SUPABASE_URL }}" ] || { echo "âŒ SUPABASE_URL missing"; exit 1; }
          [ -n "${{ secrets.SUPABASE_ANON_KEY }}" ] || { echo "âŒ SUPABASE_ANON_KEY missing"; exit 1; }
          echo "âœ… All required secrets are present"

      - name: Get version from pyproject.toml
        id: get_version
        run: |
          python -c "import tomllib,sys;print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])" | tee version.txt
          echo "version=$(cat version.txt)" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Found version: $(cat version.txt)"

      - name: Create custom payload file
        run: |
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          cat > custom_payload.json << JSON
          {
            "hiveName": "BrainLift MCP",
            "hiveDescription": "Model Context Protocol server for interacting with BrainLift.space to view, analyze, and enhance learning content with AI-powered DOK-based assessments",
            "version": "${{ steps.get_version.outputs.version }}",
            "tags": ["brainlift", "knowledge-management", "learning", "education"],
            "homePage": "${REPO_URL}",
            "env": {},
            "securitySchemes": [
              {
                "id": "oauth2",
                "type": "oauth2",
                "flows": {
                  "authorizationCode": {
                    "authorizationUrl": "https://accounts.google.com/o/oauth2/v2/auth",
                    "tokenUrl": "https://oauth2.googleapis.com/token",
                    "scopes": {
                      "openid": "OpenID Connect authentication",
                      "email": "Access user email address",
                      "profile": "Access user profile information"
                    }
                  }
                }
              }
            ],
            "oAuthClient": {
              "clientId": "${{ secrets.OAUTH_CLIENT_ID }}",
              "clientSecret": "${{ secrets.OAUTH_CLIENT_SECRET }}"
            }
          }
          JSON
          echo "ðŸ“‹ Custom payload:"; cat custom_payload.json

      - name: Create .env file for MCP server
        run: |
          cat > .env << EOF
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          EOF
          echo "ðŸ“‹ Created .env with SUPABASE_URL and SUPABASE_ANON_KEY"

      - name: Create ZIP for MCP Hive
        run: |
          ZIP_PATH="../brainlift-mcp-server.zip"
          zip -r "$ZIP_PATH" . \
            -x "*.git*" \
            "*/__pycache__/*" \
            "*.DS_Store" \
            "credentials/client-secrets*.json" \
            ".gcp-saved-token.json" \
            "logs.txt" \
            "build/*" \
            "*.egg-info/*" \
            ".venv/*" \
            ".ruff_cache/*" \
          echo "ðŸ“¦ Created zip: $ZIP_PATH"; ls -la "$ZIP_PATH"

      - name: Publish to MCP Hive
        env:
          API_KEY: ${{ secrets.MCP_HIVE_API_KEY }}
          HIVE_ID: ${{ secrets.MCP_HIVE_ID }}
        run: |
          ZIP_PATH="../brainlift-mcp-server.zip"
          CONFIG_JSON=$(jq -c '.' custom_payload.json)
          curl -sS -X PUT "$MCP_SERVER_URL/api/hives/$HIVE_ID/from-mcp-server" \
            -H "x-api-key: $API_KEY" \
            -F "zipFile=@${ZIP_PATH};type=application/zip" \
            --form-string "data=${CONFIG_JSON}"
          echo "\nâœ… Publish request sent"

      - name: Done
        run: |
          echo "ðŸŽ‰ Successfully initiated publish to MCP Hive"
